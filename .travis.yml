sudo: false
language: python
services:
  - docker
python:
  - "3.7"
branches:
  only:
    - master
env:
  - DOCKER_COMPOSE_VERSION=1.25.5
before_install:
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - sudo apt-get update
  - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
install:
  - cd backend
  - mv backend/settings/example.py backend/settings/local.py
  - cd ..
  - mv db/.env.example db/.env
  - mv frontend/.env.docker.example frontend/.env
  - docker-compose up -d
  - bash -c "./backend/wait-for-it.sh localhost:9090"
before_script:
  - docker container ps
  - sleep 15
  - docker container ps
  - docker-compose logs --tail=100 worker
  - docker-compose exec worker flake8 "." "--statistics"
  - docker-compose exec worker coverage "erase"
script: docker-compose exec worker coverage "run" "manage.py" "test"
after_success:
  - docker-compose exec worker codecov
after_script:
  - docker-compose down
